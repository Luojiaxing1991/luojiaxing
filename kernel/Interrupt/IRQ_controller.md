# 中断控制器简述

中断是计算机体系中非常重要的一种信号机制。中断控制器在这一体系中担负着“搬运工”的职责，这里面比较有名且通用的是GIC，另外还有一些级联中断控制器，例如GPIO。所以说，
一旦提及中断控制器，一般人会立马想到GIC,这是没错的，就像一提小燕子会想到赵薇一样。但是中断控制器并不只指GIC，还有其他很多提供相同功能的设备，也能被称为中断控制器。

说到中断控制器的作用，一般而言，客户（通常可以是指外设，cpu，软件，时钟等）会通过一些指定的信号（上升沿，下降沿，电平，总线消息）给中断控制器输入一个刺激信号（当然这些信号部分也能被屏蔽），
受刺激的中断控制器一边抚摸着伤口（每次中断信号的电平变动都相当于客户给了你一记电击枪）确认信号来源（通常通过寄存器中的中断标记位来记录），一边向下一级中断控制器（如果是根控制器，则直接是CPU）
传递一个刺激信号。这个一级一级往下的传递的刺激信号最终的归宿就是一段代码（我们称之为回调函数），里面有客户指定的一些响应处理。处理完毕后，各级中断控制器需要往自己接受信号的伤口上贴上创可贴
（清除寄存器中的中断标记位），这样，一次中断就完成了。

# 中断控制器的逻辑描述

## 中断域
每一个中断控制器的代码都会首先涉及struct irq_domain这个结构体，以及为自己申请一个irq_domain的资源描述。其他硬件描述如irq_chip_generic和irq_chip都是基于irq_domain来承载。irq_domain翻译过来就是
中断域，从字面理解，它描述了中断控制器的地盘（在linux IRQ number中占据多少个席位）。这个地盘的大小完全由这种中断控制器所拥有的硬中断数量来决定的，简单粗暴，相当于身上有多少伤口，能同时承受多少
电击枪的暴击（抖M值？），它就能拥有多大的地盘。

至于为什么irq_domain会在中断控制器的硬件抽象中占据这么重要的地位呢？笔者认为，对于linux各模块而言，他们眼中能看到的中断只包括三个东西，Linux IRQ number，回调函数，以及对应硬件事件含义（对于自家硬件，肯定知根知底）。
很经济实在，就像女人眼中，结婚就等于房车一样直接。那么，既然客户眼里只有这几个东西，那中断信号是通过电击枪还是通过阿姆斯特朗回旋加速喷气式阿姆斯特朗炮给你一记刺激，对客户他们来说，并不重要，
因此，通过一个mapping关系告诉客户，这个数字，表示之前不久的一个moment，发生了一件什么事情，就是最重要的事情。这就决定了irq_domain的江湖地位，不是老大，也是教主。

### 线性映射 & 树映射 & 不映射
中断控制器的驱动代码会通过irq_domain_add_*()这样的一个函数来创建和注册中断域，*号其实对应这个三类方法，linear，tree和nomap。（举个栗子，组合起来就是irq_domain_add_linear（））。这三种方式的区别在于两点：首先，nomap跟
linear/tree就不是一路人，它的硬件中断号和软件中断号是相同的，不需要映射，比如powerPC的MPIC架构。其次，linear和tree的区别在于后宫（硬中断）数量级不同，如果你的后宫妃嫔少于256个，那么linear方式就很适合你，一宫之内，为你独尊，
下面的妃嫔都用编号进行编队（hash表），来回也就百十来人，你翻牌子也容易，一张桌子放得下。而如果你的后宫数量级很大，佳丽三千，那翻牌子就不容易了，得设立一些层级结构，东宫西宫，皇后贵妃才人，不然你的桌子根本摆不下
（大数量级下，数的使用可以避免根据最大的硬件中断号来分配一个很大的表）。

PS：对应的三个API函数为： irq_domain_add_linear() irq_domain_add_tree() irq_domain_add_nomap()

### 创建映射与查找映射
创建映射： irq_create_mapping()
查找映射： irq_find_mapping()
